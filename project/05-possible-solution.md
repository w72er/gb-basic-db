# Предполагаемое решение

Порядок реализации функциональных требований:
1. ФТ-03 +
2. ФТ-05 +
3. ФТ-04 +
4. ФТ-01 +
5. ФТ-02
6. ФТ-06

Если в ходе проработки предполагаемого решения получаем артефакт, то
отмечаем его "%artifact%".

ФТ-01. Показать различия текущего и требуемого портфелей, чтобы понимать,
какие бумаги следует продать, а какие купить.

Различие отображать в виде таблицы:
```text
|название |      количество     | купить/продать |
|         | текущее | требуемое | шт    | руб    |
| VTBE    | 100     | 120       | 20    | 2000   |
```

Различие отобразить приложение. Для отображения приложению
понадобятся следующие данные:
* текущие данные портфеля (количество цена и общая стоимость
  портфеля);
* ежемесячная сумма инвестирования будет задана пользователем;
* доли тикеров в требуемом портфеле.

Поскольку конкретные ценные бумаги — это рынок страны, или группы
стран и чтобы не производить ребалансировку портфеля часто, хочется
учитывать вес стран в расчетах. Для этой цели записываем вес стран
в таблицу `country_shares`. На основании таблицы вычисляются доли
тикеров в требуемом портфеле.

Приложение с заданной периодичностью обновляет таблицу
`country_shares` с помощью двух запросов: `DELETE FROM...` и
`INSERT ... VALUES`. Чтобы приложение не обратилось в момент
пустой таблицы сократим риск с помощью транзакции.
Выполнение команды `TRUNCATE ...` было бы быстрее, но команда
прерывает транзакцию.

%artifact% Создание таблицы `country_shares` и добавление в нее
данных приведены в
[artifacts/create-06-country_shares.sql](artifacts/create-06-country_shares.sql).

ФТ-02. Оповестить о внеплановой ребалансировке, чтобы не только
привести риски в соответствии с индексом, но и заработать на
формирующемся портфеле. (Опровергнуто исследованием vanguard)

Триггер, когда просадка на указанную пользователем величину.
* выставить предел между рынком акций и облигаций
* получить отчет о том на сколько превышен выставленный предел
* получить рекомендацию сколько купить продать бумаг

ФТ-03. Вывести стоимость портфеля, чтобы понять, достигли ли мы цель.

Название ценной бумаги называется тикер. Вывести стоимость портфеля
можно в таблице:
```text
| Тикер  | Количество | Цена | Сумма |
| VTBE   | 20         | 1    | 20    |
| FXUS   | 1          | 10   | 10    |
| Итого:                     | 30    |
```

Реализация данной задачи описана по ссылке
http://www.sql-tutorial.ru/ru/book_summarizing_data_using_rollup.html,
https://stackoverflow.com/questions/17934318/add-a-summary-row-with-totals.

%artifact% Вывод стоимости портфеля осуществляется с помощью запроса 
[artifacts/print-portfolio-cost.sql](artifacts/print-portfolio-cost.sql).


* вывести отчет о весе портфеля в рублях (долларах, евро)

ФТ-04. Учитывать дробление ценных бумаг, чтобы корректно получать
количество ценных бумаг в портфеле.
Когда ты покупаешь 1 ценную бумагу, а через некоторое время, она
делится на 10, и теперь у тебя 10 ценных бумаг.

`get_multiplier(ticker_id1 BIGINT UNSIGNED, made_at DATETIME) RETURNS INT`
[artifacts/create-04-get_multiplier.sql](artifacts/create-04-get_multiplier.sql).

ФТ-05. Учесть продажу / покупку ценной бумаги, чтобы вести учет
в приложении, поскольку доступ до биржи или брокера неоправдан.

Ценную бумагу можно купить или продать, и в истории сделок можно
хранить информацию несколькими способами:
1. Количество бумаг + операция над ними;
2. +/-Количество бумаг
Первый вариант, возможно, и выглядит более гибким, позволяет в
последствии добавить short-операции, однако такая возможность
для инвестора, а не спекулянта, не востребована. С другой стороны
вычисление итогового количества ценных бумаг будет запутано:
```sql
sum(if(type='sell', -amount, amount))
```
Поэтому продажу учитываю через отрицательную величину с
комментарием к полю `amount` таблицы.

%artifact% Покупка/продажа осуществляется с помощью запросов 
[artifacts/buy-sell-ticker.sql](artifacts/buy-sell-ticker.sql).

ФТ-06. Портфели не существуют сами по себе, они формируются под цели.
