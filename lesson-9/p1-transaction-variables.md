# Транзакции

атомарная группа запросов, которая рассматривается как единое целое.
Все или ничего.
Пример, перенос средств со счета клиента на счет магазина.

```sql
start transaction
select total from users where ...
update ...
update ...
-- другие пользователи mysql не видят изменений
commit;
-- а теперь видят.
```

Если какая-то другая транзакция изменила состояние, то наша транзакция
получит ошибку.

`ROLLBACK` - отмена транзакции.

Есть команды завершающие транзакцию, и команды, которые нельзя
использовать внутри транзакции. Например, некоторые команды завершают
текущую транзакцию, кроме того транзакции не бывают вложенные, так
как команда start transaction завершает текущую и начинает новую.

## Точки сохранения.

Точки сохранения необходимы для отката не к началу транзакции, а к
точке сохранения.

* save point
* rollback to savepoint

```
start transactoion;
select *
savepoint account_4;
```

mysql работает в режиме атомарных транзакций, то есть каждая команда
это транзакция

## ACID

atomycy - все или ничего. Не существует
consistence. Согласованность, из одного непротиворечивого в другое непротиворечивое. Деньги не пропадут, а перейдут 
Isolation - до коммита пользователи будут видеть как будто ничего не произошло.
Durability - сохраняемость. Даже при потере питания деньги не пропадут.

## Уровни изоляции

В зависимости от уровня транзакции, данные транзакции могут быть
видны другим пользователям или нет.

# реализация транзакций

запросы могут останавливаться и ждать выполнения первой транзакции.

Журнал транзакций, все изменения пишутся в журнал транзакций в памяти,
затем из памяти журнала транзакций переносятся на диск журнала,
а затем фоновый процесс изменяет таблицы.

show variables like 'innodb_log_%';
ib_logfile0
ib_logfile1 -- транзакции
ibdata1 -- таблицы

При штатном выключении сервера, транзакции записываются в ibdata1.
При нештатном, данные переносятся после запуска сервера.
innodb_flush_log_at_... - 

MVCC - многоверсионный механизм повышения конкуренции при доступе
к данным.

позволяет во многих случаях отказаться

чтение никогда не блокирует запись, а запись чтрение.
repeateble и следующая

# переменная.

Переменные доступны лишь в текущей сессии.

Если переменная присваивается множественному значению, имеет
последнее значение.

нумерация строк
SET @start := 0;
SELECT @start := @start +1 AS id, value FROM tbl;

## системные переменные

SHOW VARIABLES LIKE 'read_';

системные переменные:
* глобальные 
* сеансовые

## Временная таблица

два клиента могут использовать две разные таблицы с одним
ibtemp1

## динамические запросы

prepare vrem from 'select version()';
execute vrem;

динамический запрос можно параметризовать
'... where catalog_id = ?';
set @catalog_id = 1;
execute vrem using @catalog_id;

drop - prepare - удалить

# представление

увидеть результат запроса, как будто это самостоятельная таблица.
Может служить для обратной совместимости, не показывая текущую
структуру.

create view

представления могут быть в памяти или как временные таблицы.

Вертикальные - выбор части столбцов.
Горизонтальные - ограничиваем строки.
Ограничение таблицы либо по вертикали либо горизонтали.

Представление может быть обновляемый.



